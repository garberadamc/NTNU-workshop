---
title: |
  | Random Intercept Latent Transition Analysis (RI-LTA) with {MplusAutomation}
  | ~ ~ ~
subtitle: |
  | A tutorial replicating the analyses presented in Muthén & Asparouhov (2020)
  | 
  | • Hidden Markov Models • Simulation • 2 Applied Examples • Invariance •
author: "Adam Garber"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  pdf_document:
    df_print: kable
    number_sections: no
    toc: yes
    toc_depth: 3
  html_document:
    code_folding: show
    df_print: kable
    mathjax: default
    number_sections: no
    theme: spacelab
    toc: yes
    fig_width: 9 
    fig_height: 6 
    includes:
      after_body: footer.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE, tidy = TRUE)
library(tidyverse)
library(MplusAutomation)
library(rhdf5)
library(here)
library(glue)
#library(stargazer)
library(kableExtra)
library(janitor)
#library(semPlot)
library(reshape2)
library(cowplot)
library(viridis)
library(gt)
```

<style type="text/css">
body{ font-size: 20px; max-width: 1600px; margin: auto; padding: 1em; }
code.r{ font-size: 18px; }
p { padding-top: 10px; padding-bottom: 10px; }
pre { font-size: 16px; }
</style>



***

**Source citation:** Muthén, B. & Asparouhov, T. (2020). [\textcolor{blue}{Latent Transition Analysis with Random Intercepts (RI-LTA)}](https://www.statmodel.com/download/MuthenRevision3.pdf). Under review. Version 3. 

- This tutorial was made with the intention of having readers following along in the original article. Many of the important concepts relevant to RI-LTA, discussed extensively in Muthén & Asparouhov (2020), are not included here.
- All content & concepts closely follow Muthén & Asparouhov (2020).
- All models are estimated with Mplus version 8.4 (Muthén & Muthén, 1998 - 2017) via the interface R (R Core Team, 2017) package {`MplusAutomation`} (Hallquist & Wiley, 2018).  
- The article, data, and all corresponding `Mplus` scripts can be found here: \textcolor{blue}{https://www.statmodel.com/RI-LTA.shtml}

***

Sections of Muthén & Asparouhov (2020) paper:

1. Introduction
2. Regular LTA
3. Random Intercept RI-LTA
4. Relations to other multi-level models
5. Monte Carlo simulation study
6. Applications of RI-LTA using two data examples (Mood data & Dating data)

***

# Introducing the LTA & RI-LTA models

***

## Parameters of regular LTA model

- $T$: number of time points ($t$ a discrete timepoint)
- $C_t$: categrorical latent variable at time $t$
- $U_{rit}$: latent class indicator for indicator $r$, subject $i$, and time $t$
- $M$: number of categories for observed indicators
- $K$: number of classes for latent variable $C_t$ ($k$ a discrete class)
- $\tau$: transition probability, $P(C_t = k | C_{t-1} = m)$
- $\omega_{rk}$: item and class specific threshold on the inverse logit scale
- $\pi_k$: class size for each of $C_t$ latent variables 

***

Interpreting LTA paramaters: Classification error & transition probabilities ($\tau$)
```{r, echo=FALSE, eval=TRUE, out.width = "80%", out.height= "80%", fig.pos="h"}
knitr::include_graphics(here("figures", "table1.png"))
```

*Figure 1*: Picture adapted from Muthén & Asparouhov (2020). 

***

## Common LTA assumptions

- Conditional independence: Indicators are assumed to be independent after conditioning upon class ($k$)
- Markov property: $C_t$ is only influenced by $C_{t-1}$. Also commonly called "lag-1 effects"
- Measurement invariance: of latent class indicators across Time points 
- Stationary invariance: transition probabilities are fixed (invariant) across time points 

*Note*: All model assumptions listed above may be relaxed to better fit a particular data context. 

***

## Related longitudinal models

Each of these models separates out `stable between-subject` differences from `within-subject` variance:

**Latent trait-state model**
```{r, echo=FALSE, eval=TRUE, out.width = "80%", out.height= "80%", fig.pos="h"}
knitr::include_graphics(here("figures", "trait-state.png"))
```

*Figure 2*: Latent trait-state model. Picture adapted from Kenny & Zustra (1995).

**Random intercept cross-lagged panel model (RI-CLPM)**
```{r, echo=FALSE, eval=TRUE, out.width = "50%", out.height= "50%", fig.pos="h"}
knitr::include_graphics(here("figures", "ri-clpm.png"))
```

*Figure 3*: Random intercept cross-lagged panel model. Picture is adapted from Hamaker et al., (2015). 

***

## Random intercept LTA model specification details

Continuous random intercept LTA model, unique parameters (p.11-15):

- $f_i$: The continuous random intercept latent factor. Distributed $N = (0,1)$
- $\lambda_r$: The factor loadings for each latent class indicator $U_{rit}$ which are held equal across time points (time-invariant).

```{r, echo=FALSE, eval=TRUE, out.width = "50%", out.height= "50%", fig.pos="h"}
knitr::include_graphics(here("figures", "continuous-ri.png"))
```

*Figure 4a*: Picture adapted from Muthén & Asparouhov (2020).  

Binary random intercept LTA model, unique parameters (p.15-17):

- $I_k$: The binary random intercept latent class variable with $k=2$.

```{r, echo=FALSE, eval=TRUE, out.width = "50%", out.height= "50%", fig.pos="h"}
knitr::include_graphics(here("figures", "binary-ri.png"))
```

*Figure 4b*: Picture adapted from Muthén & Asparouhov (2020). 

***

Critique of traditional LTA model:

a. Generally, the central interest in LTA is *state* changes across time points.
b. Given **a** is true, stable individual differences (between-subject variation) or *trait* variance should be separated to isolate changes in states (within-subject variation) across time.
c. If between-subject variation is not accounted for using the random-intercept approach, transition probability estimates may be significantly biased. 
d. Intuitively, removing between-subject variation is a logical step in the same manner that repeated measure designs parse out this random effect. 

***

```{r, echo=FALSE, eval=TRUE, out.width = "50%", out.height= "50%", fig.pos="h"}
knitr::include_graphics(here("figures", "Fig1.png"))
```

*Figure 5*: LTA with 1 binary indicator ($u$) at 5 time points. Picture from Muthén & Asparouhov (2020).

***

```{r, echo=FALSE, eval=TRUE, out.width = "50%", out.height= "50%", fig.pos="h"}
knitr::include_graphics(here("figures", "Fig2.png"))
```

*Figure 6*: LTA with 2 binary indicator at 3 time points. Picture from Muthén & Asparouhov (2020).

***

# Monte Carlo simulation study

Population & model characteristics:

a. 5 binary indicators ($U_{rit}$)
b. categorical latent variables $C_{t}$: Latent variables are generated to have 2 latent classes ($K = 2$)
  - class 1: logit values set to 1 (probability = 0.731) across all indicators
  - class 2: logit values set to -1 (probability = 0.269) across all indicators
  - Probability of class membership at time 1: .5 ($C_{k=1}$) and .5 ($C_{k=2}$)
c. random intercept continuous latent factor ($f$)
  - loadings ($\lambda_i$): set to 2
  - mean is fixed to 0, variance is fixed to 1
d. transition probabilities
  - `TRANS11` = .622
  - `TRANS21` = .500
e. sample size conditions ($N$): 500, 1000, 2000, 4000


```{r, echo=FALSE}

tribble(  ~"Time-1",~"Class-1",~"Class-2",
        "Class-1","0.622","0.378",
        "Class-2","0.500","0.500") %>%
  gt() %>% 
  tab_spanner(label = "Time-2",columns = 2:3)

```

***


## Simulation (1): Regular LTA model matching data generation (Time points = 2)

- data generated = regular LTA
- model = regular LTA

Note: sample size not varied due to high performance and parameter coverage for the `N=500` condition

```{r}

lta_01  <- mplusObject(
      
  TITLE = "model01_regular_lta", 
    
  MONTECARLO = 
     "NAMES = u11-u15 u21-u25;
    	GENERATE = u11-u15 u21-u25(1);
    	CATEGORICAL = u11-u15 u21-u25;
    	GENCLASSES = c1(2) c2(2);
    	CLASSES = c1(2) c2(2);
    	NOBSERVATIONS = 500;
     	NREPS = 500;", 
    
  ANALYSIS = 
      "TYPE = MIXTURE;
       ESTIMATOR = ML; 
    	 processors = 8;",
    
  MODELPOPULATION = 
      "%OVERALL%                 
      [c1#1-c2#1*0];      ! latent intercepts at 0?
  	  c2#1 on c1#1*0.5;   ! transition probability at .5      
      
 
  MODEL POPULATION-c1:
      %c1#1% 
      [u11$1*1] (p111); [u12$1*1] (p211); [u13$1*1] (p311);
      [u14$1*1] (p411); [u15$1*1] (p511);
    	%c1#2% 
    	[u11$1*-1] (p121); [u12$1*-1] (p221); [u13$1*-1] (p321);
    	[u14$1*-1] (p421); [u15$1*-1] (p521);

  MODEL POPULATION-c2:	
      %c2#1% 
      [u21$1*1] (p111); [u22$1*1] (p211); [u23$1*1] (p311);
      [u24$1*1] (p411); [u25$1*1] (p511);
    	%c2#2% 
      [u21$1*-1] (p121); [u22$1*-1] (p221); [u23$1*-1] (p321);
      [u24$1*-1] (p421); [u25$1*-1] (p521); ",

  MODEL = 
    "%OVERALL%
     [c1#1-c2#1*0] (par1-par2);
  	 c2#1 on c1#1*0.5 (par11); 
  
  MODEL c1:
      %c1#1%
      [u11$1*1] (p111); [u12$1*1] (p211); [u13$1*1] (p311);
      [u14$1*1] (p411); [u15$1*1] (p511);
    	%c1#2% 
    	[u11$1*-1] (p121); [u12$1*-1] (p221); [u13$1*-1] (p321);
    	[u14$1*-1] (p421); [u15$1*-1] (p521);

  MODEL c2: 	
      %c2#1% 
      [u21$1*1] (p111); [u22$1*1] (p211); [u23$1*1] (p311);
      [u24$1*1] (p411); [u25$1*1] (p511);
    	%c2#2% 
      [u21$1*-1] (p121); [u22$1*-1] (p221); [u23$1*-1] (p321);
      [u24$1*-1] (p421); [u25$1*-1] (p521);",

  MODELCONSTRAINT =
       "! Compute joint and marginal probabilities:
        New(
        trans11*.622 trans12*.378 trans21*.5 trans22*.5
        prob11*.5 prob12*.5 prob21*.561 prob22*.439);

        trans11 = 1/(1+exp(-(par2+par11)));
        trans12 = 1-trans11;
        trans21 = 1/(1+exp(-par2));
        trans22 = 1- trans21;
        ! marginal probabilities at T1 and T2:
        prob11 = 1/(1+exp(-par1));
        prob12 = 1 - prob11;
        prob21 = prob11*trans11+prob12*trans21;
        prob22 = 1- prob21;",

  OUTPUT = "")

lta_01_fit <- mplusModeler(lta_01, 
                            dataout=here("sim1_LTA", "sim1_lta01.dat"),
                            modelout=here("sim1_LTA", "sim1_lta01.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)
```

***

## Simulation (2): Regular LTA model matching data generation (Time points = 3)

- data generated = regular LTA
- model = regular LTA

Note: sample size not varied

```{r}

lta_02  <- mplusObject(
      
  TITLE = "model02_regular_lta", 
    
  MONTECARLO = 
     "NAMES = u11-u15 u21-u25 u31-u35;
    	GENERATE = u11-u15 u21-u25 u31-u35(1);
    	CATEGORICAL = u11-u15 u21-u25 u31-u35;
    	GENCLASSES = c1(2) c2(2) c3(2);
    	CLASSES = c1(2) c2(2) c3(2);
    	NOBSERVATIONS = 500;
     	NREPS = 500;", 
    
  ANALYSIS = 
      "TYPE = MIXTURE;
       ESTIMATOR = ML; 
    	 processors = 8;",
    
  MODELPOPULATION = 
      "%OVERALL%                 
      [c1#1-c3#1*0];      ! 
  	  c2#1 on c1#1*0.5;   ! transition probability at .5      
      c3#1 on c2#1*0.5;   !
 
  MODEL POPULATION-c1:
      %c1#1% 
      [u11$1*1] (p111); [u12$1*1] (p211); [u13$1*1] (p311);
      [u14$1*1] (p411); [u15$1*1] (p511);
    	%c1#2% 
    	[u11$1*-1] (p121); [u12$1*-1] (p221); [u13$1*-1] (p321);
    	[u14$1*-1] (p421); [u15$1*-1] (p521);

  MODEL POPULATION-c2:	
      %c2#1% 
      [u21$1*1] (p111); [u22$1*1] (p211); [u23$1*1] (p311);
      [u24$1*1] (p411); [u25$1*1] (p511);
    	%c2#2% 
      [u21$1*-1] (p121); [u22$1*-1] (p221); [u23$1*-1] (p321);
      [u24$1*-1] (p421); [u25$1*-1] (p521); 
  
  MODEL POPULATION-c3: 	
    	%c3#1% 
    	[u31$1*1] (p111); [u32$1*1] (p211); [u33$1*1] (p311);
    	[u34$1*1] (p411); [u35$1*1] (p511);
    	%c3#2% 
      [u31$1*-1] (p121); [u32$1*-1] (p221); [u33$1*-1] (p321);
      [u34$1*-1] (p421); [u35$1*-1] (p521); ",

  MODEL = 
    "%OVERALL%
     [c1#1-c3#1*0] (par1-par3);
  	 c2#1 on c1#1*0.5 (par11); 
     c3#1 on c2#1*0.5;
     
  MODEL c1:
      %c1#1% 
      [u11$1*1] (p111); [u12$1*1] (p211); [u13$1*1] (p311);
      [u14$1*1] (p411); [u15$1*1] (p511);
    	%c1#2% 
    	[u11$1*-1] (p121); [u12$1*-1] (p221); [u13$1*-1] (p321);
    	[u14$1*-1] (p421); [u15$1*-1] (p521);

  MODEL c2: 	
      %c2#1% 
      [u21$1*1] (p111); [u22$1*1] (p211); [u23$1*1] (p311);
      [u24$1*1] (p411); [u25$1*1] (p511);
    	%c2#2% 
      [u21$1*-1] (p121); [u22$1*-1] (p221); [u23$1*-1] (p321);
      [u24$1*-1] (p421); [u25$1*-1] (p521); 
        
  MODEL c3: 	
    	%c3#1% 
    	[u31$1*1] (p111); [u32$1*1] (p211); [u33$1*1] (p311);
    	[u34$1*1] (p411); [u35$1*1] (p511);
    	%c3#2% 
      [u31$1*-1] (p121); [u32$1*-1] (p221); [u33$1*-1] (p321);
      [u34$1*-1] (p421); [u35$1*-1] (p521); ",

  MODELCONSTRAINT =
       "! Compute joint and marginal probabilities:
        New(
        trans11*.622 trans12*.378 trans21*.5 trans22*.5
        prob11*.5 prob12*.5 prob21*.561 prob22*.439);

        trans11 = 1/(1+exp(-(par2+par11)));
        trans12 = 1-trans11;
        trans21 = 1/(1+exp(-par2));
        trans22 = 1- trans21;
        !marginal probabilities at T1 and T2:
        prob11 = 1/(1+exp(-par1));
        prob12 = 1 - prob11;
        prob21 = prob11*trans11+prob12*trans21;
        prob22 = 1- prob21;",

  OUTPUT = "")

lta_02_fit <- mplusModeler(lta_02, 
                            dataout=here("sim1_LTA", "sim1_lta02.dat"),
                            modelout=here("sim1_LTA", "sim1_lta02.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)
```

***

## Simulation (3): Regular LTA model misspecified relative to data generation (Time points = 3)

- data generated = RI-LTA 
- model = regular LTA

```{r}

  lta_03  <- mplusObject(
      
  TITLE = "model02_regular_lta", 
    
  MONTECARLO = 
     "NAMES = u11-u15 u21-u25 u31-u35;
    	GENERATE = u11-u15 u21-u25 u31-u35(1);
    	CATEGORICAL = u11-u15 u21-u25 u31-u35;
    	GENCLASSES = c1(2) c2(2) c3(2);
    	CLASSES = c1(2) c2(2) c3(2);
    	NOBSERVATIONS = 500;
     	NREPS = 500;", 
    
  ANALYSIS = 
      "TYPE = MIXTURE;
       ESTIMATOR = ML; 
    	 processors = 8;",
    
  MODELPOPULATION = 
      "%OVERALL%                 
      [c1#1-c3#1*0];      ! 
  	  c2#1 on c1#1*0.5;   ! transition probability at .5      
      c3#1 on c2#1*0.5;   !
 
  MODEL POPULATION-c1:
      %c1#1% 
      [u11$1*1] (p111); [u12$1*1] (p211); [u13$1*1] (p311);
      [u14$1*1] (p411); [u15$1*1] (p511);
    	%c1#2% 
    	[u11$1*-1] (p121); [u12$1*-1] (p221); [u13$1*-1] (p321);
    	[u14$1*-1] (p421); [u15$1*-1] (p521);

  MODEL POPULATION-c2:	
      %c2#1% 
      [u21$1*1] (p111); [u22$1*1] (p211); [u23$1*1] (p311);
      [u24$1*1] (p411); [u25$1*1] (p511);
    	%c2#2% 
      [u21$1*-1] (p121); [u22$1*-1] (p221); [u23$1*-1] (p321);
      [u24$1*-1] (p421); [u25$1*-1] (p521); 
  
  MODEL POPULATION-c3: 	
    	%c3#1% 
    	[u31$1*1] (p111); [u32$1*1] (p211); [u33$1*1] (p311);
    	[u34$1*1] (p411); [u35$1*1] (p511);
    	%c3#2% 
      [u31$1*-1] (p121); [u32$1*-1] (p221); [u33$1*-1] (p321);
      [u34$1*-1] (p421); [u35$1*-1] (p521); ",

  MODEL = 
    "%OVERALL%
     [c1#1-c3#1*0] (par1-par3);
  	 c2#1 on c1#1*0.5 (par11); 
     c3#1 on c2#1*0.5;
     
  MODEL c1:
      %c1#1% 
      [u11$1*1] (p111); [u12$1*1] (p211); [u13$1*1] (p311);
      [u14$1*1] (p411); [u15$1*1] (p511);
    	%c1#2% 
    	[u11$1*-1] (p121); [u12$1*-1] (p221); [u13$1*-1] (p321);
    	[u14$1*-1] (p421); [u15$1*-1] (p521);

  MODEL c2: 	
      %c2#1% 
      [u21$1*1] (p111); [u22$1*1] (p211); [u23$1*1] (p311);
      [u24$1*1] (p411); [u25$1*1] (p511);
    	%c2#2% 
      [u21$1*-1] (p121); [u22$1*-1] (p221); [u23$1*-1] (p321);
      [u24$1*-1] (p421); [u25$1*-1] (p521); 
        
  MODEL c3: 	
    	%c3#1% 
    	[u31$1*1] (p111); [u32$1*1] (p211); [u33$1*1] (p311);
    	[u34$1*1] (p411); [u35$1*1] (p511);
    	%c3#2% 
      [u31$1*-1] (p121); [u32$1*-1] (p221); [u33$1*-1] (p321);
      [u34$1*-1] (p421); [u35$1*-1] (p521); ",

  MODELCONSTRAINT =
       "! Compute joint and marginal probabilities:
        New(trans11*.622 trans12*.378 trans21*.5 trans22*.5
        prob11*.5 prob12*.5 prob21*.561 prob22*.439);

        trans11 = 1/(1+exp(-(par2+par11)));
        trans12 = 1-trans11;
        trans21 = 1/(1+exp(-par2));
        trans22 = 1- trans21;
        !marginal probabilities at T1 and T2:
        prob11 = 1/(1+exp(-par1));
        prob12 = 1 - prob11;
        prob21 = prob11*trans11+prob12*trans21;
        prob22 = 1- prob21;",

  OUTPUT = "")

lta_03_fit <- mplusModeler(lta_03, 
                            dataout=here("sim1k_LTA", "sim03_lta.dat"),
                            modelout=here("sim1k_LTA", "sim03_lta.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)

```


***

## Simulation (4) step 1: RI-LTA model matching data generation (sample size varied)

Data generated by RI-LTA model (Time points = 2)

**Vary sample size:** Estimate RI-LTA models with T = 2 for sample sizes 500, 1000, 1500, 2000, 2500 

```{r}

# looping over N-sizes conditions

t2_rilta  <- lapply(1:5, function(k) {
  t2_nsize  <- mplusObject(
  
  TITLE = "T2RILTA - vary n-size", 
  
    MONTECARLO = 
glue("NAMES = u11-u15 u21-u25;
    	GENERATE = u11-u15 u21-u25(1);
    	CATEGORICAL = u11-u15 u21-u25;
    	GENCLASSES = c1(2) c2(2);
    	CLASSES = c1(2) c2(2);
    	NOBSERVATIONS = {k*500};
    	SEED = 3252020;
     	NREPS = 5; !rep number reduced for demo (real sim use 500,1000)
      repsave = all;
      save = {k}_t2n500rep*.dat;
      RESULTS = t2results{k}.csv;"), 
    
  ANALYSIS = 
      "TYPE = MIXTURE;
       algorithm = integration;
    	 processors = 8;",
    
  MODELPOPULATION = 
      "%OVERALL%

      [c1#1-c2#1*0];
      c2#1 on c1#1*0.5;

      f by u11-u15*2 (p1-p5)
           u21-u25*2 (p1-p5);
           
    	f@1; [f@0]; ! set factor variance to 1 and mean to 0
 
  MODEL POPULATION-c1:
      %c1#1% 
      [u11$1*1] (p111); [u12$1*1] (p211); [u13$1*1] (p311);
      [u14$1*1] (p411); [u15$1*1] (p511);
    	%c1#2% 
    	[u11$1*-1] (p121); [u12$1*-1] (p221); [u13$1*-1] (p321);
    	[u14$1*-1] (p421); [u15$1*-1] (p521);

  MODEL POPULATION-c2:	
      %c2#1% 
      [u21$1*1] (p111); [u22$1*1] (p211); [u23$1*1] (p311);
      [u24$1*1] (p411); [u25$1*1] (p511);
    	%c2#2% 
      [u21$1*-1] (p121); [u22$1*-1] (p221); [u23$1*-1] (p321);
      [u24$1*-1] (p421); [u25$1*-1] (p521); ",

  MODEL = 
    "%OVERALL%

    [c1#1-c2#1*0] (par1-par2);
  	c2#1 on c1#1*0.5 (par11);

    f by u11-u15*2 (p1-p5)
         u21-u25*2 (p1-p5);
         
    f@1; [f@0];
     
  MODEL c1:
      %c1#1%
      [u11$1*1] (p111); [u12$1*1] (p211); [u13$1*1] (p311);
      [u14$1*1] (p411); [u15$1*1] (p511);
    	%c1#2% 
    	[u11$1*-1] (p121); [u12$1*-1] (p221); [u13$1*-1] (p321);
    	[u14$1*-1] (p421); [u15$1*-1] (p521);

  MODEL c2: 	
      %c2#1% 
      [u21$1*1] (p111); [u22$1*1] (p211); [u23$1*1] (p311);
      [u24$1*1] (p411); [u25$1*1] (p511);
    	%c2#2% 
      [u21$1*-1] (p121); [u22$1*-1] (p221); [u23$1*-1] (p321);
      [u24$1*-1] (p421); [u25$1*-1] (p521);",

  MODELCONSTRAINT =
       "! Compute joint and marginal probabilities:
        New(
        trans11*.622 trans12*.378 trans21*.5 trans22*.5
        prob11*.5 prob12*.5 prob21*.561 prob22*.439);
        trans11 = 1/(1+exp(-(par2+par11)));
        trans12 = 1-trans11;
        trans21 = 1/(1+exp(-par2));
        trans22 = 1- trans21;
        !marginal probabilities at T1 and T2:
        prob11 = 1/(1+exp(-par1));
        prob12 = 1 - prob11;
        prob21 = prob11*trans11+prob12*trans21;
        prob22 = 1- prob21;"
)

t2_nsize.fit <- mplusModeler(t2_nsize, 
                dataout=here("sim2_RI1", "t2_nsize_sim.dat"),
                modelout=sprintf(here("sim2_RI1", "%d_t2_nsize_sim.inp"), k),
                check=TRUE, run = TRUE, hashfilename = FALSE)
})
```

***

Coerce the simulation `results` output files to format for readable tables
```{r, eval=TRUE, results='hide'}

sim2 <- here("sim2_RI1")

fs::dir_ls(sim2)

all_csv <- fs::dir_ls(sim2, regexp = "\\.csv$")

all_results <- fs::dir_ls(sim2, regexp = "\\.csv$") %>% 
  map_dfr(read.csv, sep = " ", header = F)

all_results2 <- as.data.frame(format(all_results,scientific=F))

fit_results <- all_results2 %>% slice(8:nrow(all_results2)) %>% 
 slice(which(row_number() %% 9 == 1)) %>% 
 select(V1:V8) 

fit_results2 <- fit_results %>%
 mutate(Condition = as.array(rep(1:5, each = 5))) %>% 
 mutate(Rep_Num = as.array(rep(1:5, 5))) %>% 
 purrr::modify_if(is.character, as.numeric) %>% 
 select(9:10,1:8) %>% 
 rename(
      H0_LL = V1,
   Free_Par = V2,
        AIC = V3,
        BIC = V4,
       aBIC = V5,
    Chi_Val = V6,
    Chi_DF  = V7,
      Chi_P = V8) %>% 
  mutate(Condition = factor(Condition,
          labels = c(`1` = "N=500", `2` = "N=1000", `3`= "N=1500",
                     `4` = "N=2000",`5` = "N=2500")))
```

Make table with each replication by condition as separate row
```{r, eval=TRUE}
fit_results2 %>%  
  kable(booktabs = T) %>% 
  kable_styling(latex_options = c("scale_down", linesep = ""), 
                full_width = F,
                position = "left")
```

***

Make table with each condition as separate row (averaged across replications)
```{r, eval=TRUE}
fit_by_cond <- fit_results2 %>% 
  group_by(Condition) %>% 
  summarize(
    avg_H0_LL = mean(H0_LL),
    avg_Par   = mean(Free_Par),
    avg_AIC   = mean(AIC),
    avg_BIC   = mean(BIC),
    avg_aBIC  = mean(aBIC),
    avg_Chi_Val = mean(Chi_Val),
    avg_Chi_DF  = mean(Chi_DF),
    avg_Chi_P   = mean(Chi_P),
  ) %>% 
  bind_rows(summarise_all(., funs(if(is.numeric(.)) mean(.) else "Total"))) %>% 
  adorn_rounding(digits = 2)
  

fit_by_cond %>%  
  kable(booktabs = T) %>% 
  kable_styling(latex_options = c("scale_down", linesep = ""), 
                full_width = F,
                position = "left")


```

***

```{r, eval=FALSE, include=FALSE}
## OUTDATED extract fit information from RESULTS output across replications

t2results <-  read.csv(here("sim2_RI1", "t2results1.csv"), 
                       sep = " ", header = F, )

t2results <- as.data.frame(format(t2results,scientific=F))


fit_results <- t2results %>% slice(8:nrow(t2results)) %>% 
 slice(which(row_number() %% 9 == 1)) %>% 
 select(V1:V8) 

fit_results <- fit_results %>% 
 mutate(Rep_Num = as.array(1:nrow(fit_results))) %>% 
 purrr::modify_if(is.character, as.numeric) %>% 
 select(9,1:8) %>% 
 rename(
      H0_LL = V1,
   Free_Par = V2,
        AIC = V3,
        BIC = V4,
       aBIC = V5,
    Chi_Val = V6,
    Chi_DF  = V7,
      Chi_P = V8)

# make table with each replication by condition as separate row
fit_results %>%  
  kable(booktabs = T) %>% 
  kable_styling(latex_options = c("scale_down", linesep = ""), 
                full_width = F,
                position = "left")

# var_names <- rep(c(
#     "Rep",
#     "Par",
#     "SE",
#     "H0_LL",
#     "Free_Par",
#     "AIC",
#     "BIC",
#     "aBIC",
#     "Chi_Val",
#     "Chi_DF",
#     "Chi_P",
#     "LChi_Va",
#     "LChi_DF",
#     "LChi_P"
#     ),5)
# 
# res <- t2results %>% 
#   mutate(rname = as.factor(var_names)) %>% 
#   pivot_longer(X1:X10, # The columns I'm gathering together
#            names_to = "vars", # new column name for existing names
#            values_to = "values") # new column name to store values
#   
#   # %>% column_to_rownames(var="rname") 

```


```{r, eval=TRUE}

fit_long <- fit_results2 %>% 
  select(1:3,5:8) %>% 
  pivot_longer(H0_LL:aBIC,            # gathering columns
               names_to = "variable", # new column >> names
               values_to = "value")   # new column >> values

fit_long %>%
  ggplot(., aes(x=Rep_Num,
                y=value,
                group=Condition,
                color=Condition)) +
  geom_point() +
  geom_line() +
  scale_color_viridis_d() +
  facet_wrap(~variable, scales = "free") +
  theme_minimal() + 
  labs(x= "Replication Number",
       y= "Fit Indice Value")
```

```{r}  
ggsave(here("figures", "fit_results.png"), height = 6, width = 8)
```


***

## Simulation (4) step 2: RI-LTA model matching data generation (Time points = 2)

```{r}

replist_m1 <- read.csv(here("sim2_RI1", "1_t2n500replist.dat"),
                      header = F)


s2_rilta_1  <- mplusObject(
      
  TITLE = "m01_step2_ri_lta_t2", 
    
  DATA = 
  glue("{as.list.data.frame(here('sim2_RI1', '1_t2n500replist.dat;'))}
  type = montecarlo;"), 
  
  VARIABLE = 
     "NAMES = u11-u15 u21-u25 class1 class2;
    	usev = u11-u25;
    	CATEGORICAL = u11-u15 u21-u25;

    	CLASSES = c1(2) c2(2);",
    
  ANALYSIS = 
      "TYPE = MIXTURE;
       algorithm = integration;
    	 processors = 8;",

  MODEL = 
    "%OVERALL%

    [c1#1-c2#1*0] (par1-par2);
  	c2#1 on c1#1*0.5 (par11);
     
  MODEL c1:
      %c1#1%
      [u11$1*1] (p111); [u12$1*1] (p211); [u13$1*1] (p311);
      [u14$1*1] (p411); [u15$1*1] (p511);
    	%c1#2% 
    	[u11$1*-1] (p121); [u12$1*-1] (p221); [u13$1*-1] (p321);
    	[u14$1*-1] (p421); [u15$1*-1] (p521);

  MODEL c2: 	
      %c2#1% 
      [u21$1*1] (p111); [u22$1*1] (p211); [u23$1*1] (p311);
      [u24$1*1] (p411); [u25$1*1] (p511);
    	%c2#2% 
      [u21$1*-1] (p121); [u22$1*-1] (p221); [u23$1*-1] (p321);
      [u24$1*-1] (p421); [u25$1*-1] (p521);",

  MODELCONSTRAINT =
       "! Compute joint and marginal probabilities:
        New(
        trans11*.622 trans12*.378 trans21*.5 trans22*.5
        prob11*.5 prob12*.5 prob21*.561 prob22*.439);

        trans11 = 1/(1+exp(-(par2+par11)));
        trans12 = 1-trans11;
        trans21 = 1/(1+exp(-par2));
        trans22 = 1- trans21;
        !marginal probabilities at T1 and T2:
        prob11 = 1/(1+exp(-par1));
        prob12 = 1 - prob11;
        prob21 = prob11*trans11+prob12*trans21;
        prob22 = 1- prob21;")
 


# does not work (unable to save as dataframe without rownames)
s2_rilta_1_fit <- mplusModeler(s2_rilta_1, 
                            modelout=here("sim2_RI1", "step2_rilta_1.inp"),
                            check=TRUE, run = FALSE, hashfilename = FALSE)

#SOLUTION: must edit input file, copy and paste following filepath (overwrite previous): "/Users/agarber/Desktop/RI-LTA_Muthen20/sim2_RI1/1_t2n500replist.dat"; 

runModels(here("sim2_RI1", "step2_rilta_1.inp"))
```

***

## Simulation (5) step 1: RI-LTA model matching data generation (Time points = 3)

```{r}

# looping over sample sizes 

t3_rilta  <- lapply(1:5, function(k) {
  t3_nsize  <- mplusObject(
  
  TITLE = "T3RILTA - vary n-size", 
  
    MONTECARLO = 
glue("NAMES = u11-u15 u21-u25 u31-u35;
    	GENERATE = u11-u15 u21-u25 u31-u35(1);
    	CATEGORICAL = u11-u15 u21-u25 u31-u35;
    	GENCLASSES = c1(2) c2(2) c3(2);
    	CLASSES = c1(2) c2(2) c3(2);
    	NOBSERVATIONS = {k*500};
      SEED = 3252020;
     	NREPS = 5; !rep number reduced for demo (real sim use 500,1000)
      repsave = all;
      save = {k}_t3n500rep*.dat;
      RESULTS = t3results{k}.csv;"), 
    
  ANALYSIS = 
      "TYPE = MIXTURE;
       algorithm = integration;
    	 processors = 8;",
    
  MODELPOPULATION = 
      "%OVERALL%
      
      [c1#1-c3#1*0];      
  	  c2#1 on c1#1*0.5;    
      c3#1 on c2#1*0.5;

      f by u11-u15*2 (p1-p5)
           u21-u25*2 (p1-p5)
           u31-u35*2 (p1-p5);
           
    	f@1; [f@0];

  MODEL POPULATION-c1:
      %c1#1% 
      [u11$1*1] (p111); [u12$1*1] (p211); [u13$1*1] (p311);
      [u14$1*1] (p411); [u15$1*1] (p511);
    	%c1#2% 
    	[u11$1*-1] (p121); [u12$1*-1] (p221); [u13$1*-1] (p321);
    	[u14$1*-1] (p421); [u15$1*-1] (p521);

  MODEL POPULATION-c2:	
      %c2#1% 
      [u21$1*1] (p111); [u22$1*1] (p211); [u23$1*1] (p311);
      [u24$1*1] (p411); [u25$1*1] (p511);
    	%c2#2% 
      [u21$1*-1] (p121); [u22$1*-1] (p221); [u23$1*-1] (p321);
      [u24$1*-1] (p421); [u25$1*-1] (p521); 
  
  MODEL POPULATION-c3: 	
    	%c3#1% 
    	[u31$1*1] (p111); [u32$1*1] (p211); [u33$1*1] (p311);
    	[u34$1*1] (p411); [u35$1*1] (p511);
    	%c3#2% 
      [u31$1*-1] (p121); [u32$1*-1] (p221); [u33$1*-1] (p321);
      [u34$1*-1] (p421); [u35$1*-1] (p521); ",


  MODEL = 
    "%OVERALL%

     [c1#1-c3#1*0] (par1-par3);

  	c2#1 on c1#1*0.5 (par11);
    c3#1 on c2#1*0.5;


      f by u11-u15*2 (p1-p5)
           u21-u25*2 (p1-p5)
           u31-u35*2 (p1-p5);
    	
    	f@1; [f@0];
     
  MODEL c1:
      %c1#1% 
      [u11$1*1] (p111); [u12$1*1] (p211); [u13$1*1] (p311);
      [u14$1*1] (p411); [u15$1*1] (p511);
    	%c1#2% 
    	[u11$1*-1] (p121); [u12$1*-1] (p221); [u13$1*-1] (p321);
    	[u14$1*-1] (p421); [u15$1*-1] (p521);

  MODEL c2: 	
      %c2#1% 
      [u21$1*1] (p111); [u22$1*1] (p211); [u23$1*1] (p311);
      [u24$1*1] (p411); [u25$1*1] (p511);
    	%c2#2% 
      [u21$1*-1] (p121); [u22$1*-1] (p221); [u23$1*-1] (p321);
      [u24$1*-1] (p421); [u25$1*-1] (p521); 
        
  MODEL c3: 	
    	%c3#1% 
    	[u31$1*1] (p111); [u32$1*1] (p211); [u33$1*1] (p311);
    	[u34$1*1] (p411); [u35$1*1] (p511);
    	%c3#2% 
      [u31$1*-1] (p121); [u32$1*-1] (p221); [u33$1*-1] (p321);
      [u34$1*-1] (p421); [u35$1*-1] (p521); ",

  MODELCONSTRAINT =
       "! Compute joint and marginal probabilities:
        New(
        trans11*.622 trans12*.378 trans21*.5 trans22*.5
        prob11*.5 prob12*.5 prob21*.561 prob22*.439);

        trans11 = 1/(1+exp(-(par2+par11)));
        trans12 = 1-trans11;
        trans21 = 1/(1+exp(-par2));
        trans22 = 1- trans21;
        !marginal probabilities at T1 and T2:
        prob11 = 1/(1+exp(-par1));
        prob12 = 1 - prob11;
        prob21 = prob11*trans11+prob12*trans21;
        prob22 = 1- prob21;"
)

t3_nsize.fit <- mplusModeler(t3_nsize, 
                            modelout= sprintf(here("sim3_RI2", "%d_t3_nsize_sim.inp"), k),
                            check=TRUE, run = TRUE, hashfilename = FALSE)
})

```

***

## Simulation (5) step 2: RI-LTA model matching data generation (Time points = 3)

for condition: N = 500

```{r}

replist_m2 <- read.csv(here("sim3_RI2", "1_t3n500replist.dat"),
                       header = F) %>% remove_rownames()



s2_rilta_2  <- mplusObject(
      
  TITLE = "m01_step2_ri_lta_t2", 
    
  DATA = 
  glue("{here('sim2_RI1', '1_t3n500replist.dat;')}
      type = montecarlo;"), 
  
  VARIABLE = 
     "NAMES = u11-u15 u21-u25 u31-u35
      class1 class2 class3;
      usev = u11-u35;
    	CATEGORICAL = u11-u15 u21-u25 u31-u35;
    	CLASSES = c1(2) c2(2) c3(2); ",
    
  ANALYSIS = 
      "TYPE = MIXTURE;
       algorithm = integration;
    	 processors = 8;",

  MODEL = 
    "%OVERALL%
      [c1#1-c3#1*0] (par1-par3);
  	  c2#1 on c1#1*0.5 (par11);
      c3#1 on c2#1*0.5;
     
  MODEL c1:
      %c1#1% 
      [u11$1*1] (p111); [u12$1*1] (p211); [u13$1*1] (p311);
      [u14$1*1] (p411); [u15$1*1] (p511);
    	%c1#2% 
    	[u11$1*-1] (p121); [u12$1*-1] (p221); [u13$1*-1] (p321);
    	[u14$1*-1] (p421); [u15$1*-1] (p521);

  MODEL c2: 	
      %c2#1% 
      [u21$1*1] (p111); [u22$1*1] (p211); [u23$1*1] (p311);
      [u24$1*1] (p411); [u25$1*1] (p511);
    	%c2#2% 
      [u21$1*-1] (p121); [u22$1*-1] (p221); [u23$1*-1] (p321);
      [u24$1*-1] (p421); [u25$1*-1] (p521); 
        
  MODEL c3: 	
    	%c3#1% 
    	[u31$1*1] (p111); [u32$1*1] (p211); [u33$1*1] (p311);
    	[u34$1*1] (p411); [u35$1*1] (p511);
    	%c3#2% 
      [u31$1*-1] (p121); [u32$1*-1] (p221); [u33$1*-1] (p321);
      [u34$1*-1] (p421); [u35$1*-1] (p521); ",

  MODELCONSTRAINT =
       "! Compute joint and marginal probabilities:
        New(
        trans11*.622 trans12*.378 trans21*.5 trans22*.5
        prob11*.5 prob12*.5 prob21*.561 prob22*.439);

        trans11 = 1/(1+exp(-(par2+par11)));
        trans12 = 1-trans11;
        trans21 = 1/(1+exp(-par2));
        trans22 = 1- trans21;
        !marginal probabilities at T1 and T2:
        prob11 = 1/(1+exp(-par1));
        prob12 = 1 - prob11;
        prob21 = prob11*trans11+prob12*trans21;
        prob22 = 1- prob21;")

# does not work (unable to save as dataframe without rownames)

s2_rilta_2_fit <- mplusModeler(s2_rilta_2, 
                            modelout=here("sim3_RI2", "step2_rilta_t3.inp"),
                            check=TRUE, run = FALSE, hashfilename = FALSE, writeData = 'never')

#SOLUTION: must edit input file, copy and paste following filepath (overwrite previous): "/Users/agarber/Desktop/RI-LTA_Muthen20/sim2_RI1/1_t3n500replist.dat"; 

runModels(here("sim3_RI2", "step2_rilta_t3.inp"))
```

***

# Analysis of 2 applied data examples 

LTA model varients:

a. regular LTA
b. continuous random intercept 
c. binary random intercept 

Additionally, the LTA variants above are incorporated with the following modeling extensions:

- mover-stayer model component (i.e., a higher-order latent class variable)
- cross-group invariance (i.e., analogous to a MIMIC model or a grouping covariate)
- additional covariates and/or outcomes

***

Choice of model is based on the `BIC`:

   $$BIC = -2*LogLikelihood + p * ln  (N)$$
   
   - P = number of parameters
   - N = Sample size

***

# Mood data example (Eid & Langeheine, 2003)

- Sample size (N) = 494
- Time points = 4 (3-weeks apart)
- Mixture model (LCA)
    - 2 binary indicators ($Ui$)
    - 2 latent classes ($C_{k=2}$)
- Indicators - participants rated momentary sadness and unhappiness
  - Likert ranging from 1 (not at all) to 5 (very much) recoded to binary:
    - Category 1 = "not at all"
    - Category 2 = all other categories
    
- Assumptions:
  1. Stationarity invariance (across 3 transition matrices; following models in Eid & Langeheine, 2003)
  2. Longitudinal invariance (across the 4 time point latent variables)

  
***

**Models considered for the mood example:**

- Models 1-3 standard analyses
- Models 4-6 Mover-Stayer analysis (mover-stayer factor has $k=2$)

***

```{r, echo=FALSE, eval=TRUE, out.width = "50%", out.height= "50%", fig.pos="h"}
knitr::include_graphics(here("figures", "table5_rilta.png"))
```

*Figure 7*: Picture adapted from Muthén & Asparouhov (2020).

***

# Comparison of LTA modeling approaches to mood data

## Mood Model 1 - Regular LTA

Read in the `Mood` data file
```{r}

mood_data <-  read_csv(here("data", "eid-langeheine-mood.csv"), col_names = FALSE) 
  
colnames(mood_data) <-  c("u11", "u12", "u21", "u22", "u31", "u32", "u41", "u42", "freq", "est", "sd")

```


```{r}

m1_mood  <- mplusObject(
      
  TITLE = 
     "Eid 2003 data: T=4, N=494, P=2, C=2
      Regular LTA, stationary", 
  
  VARIABLE = 
     "usev = u11-u42;
      freqweight = freq;
      categorical = u11-u42;
      classes = c1(2) c2(2) c3(2) c4(2);",
    
  ANALYSIS = 
     "type = mixture;
      proc = 8;
      starts = 400 100;",

  MODEL = 
     "%OVERALL%
      [c2#1 - c4#1] (p0);

    	c4#1 on c3#1 (pt);
      c3#1 on c2#1 (pt);
    	c2#1 on c1#1 (pt);

    ! csharp by;
    ! csharp by c1#1@1 c2#1@1 c3#1@1;
    ! csharp*0.5; [csharp@0]; csharp with f@0;
    ! csharp on w*1;

    MODEL c1:
      	%c1#1%
      	[u11$1] (1);   [u12$1] (2);
      	%c1#2%
      	[u11$1] (11);  [u12$1] (12);
      	
    MODEL c2: 	
      	%c2#1%
      	[u21$1] (1);  [u22$1] (2);
      	%c2#2%
      	[u21$1] (11); [u22$1] (12);
      	
    MODEL c3:
        %c3#1%
      	[u31$1] (1);  [u32$1] (2);
      	%c3#2%
      	[u31$1] (11); [u32$1] (12);

    MODEL c4:
        %c4#1%
      	[u41$1] (1);  [u42$1] (2);
      	%c4#2%
      	[u41$1] (11); [u42$1] (12); ",

  OUTPUT = "tech1 tech15;",
  
  usevariables = colnames(mood_data),
  rdata = mood_data)

m1_mood.fit <- mplusModeler(m1_mood, 
                            modelout=here("mood_mplus", "m1_mood.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)

```

***

## Mood Model 2  - RI-LTA, binary RI

***

NOTE: use of `update()`, selected syntax is used from base model `m1_mood` 
```{r}

m2_mood  <- update(m1_mood,
      
  TITLE = ~
     "Eid 2003 data: T=4, N=494, P=2, C=2
      Model 2", 
  
  VARIABLE = ~
     "usev = u11-u42;
      categorical = u11-u42;
      classes = t(2) c1(2) c2(2) c3(2) c4(2);
      freqweight = freq;",

  MODEL = ~
 "%OVERALL%
      ! stationary markov

      [c2#1-c4#1] (p0);

      c4 on c3 (pt);
      c3 on c2 (pt);
      c2 on c1 (pt);

  MODEL t.c1:
  ! (item,t class, c class): 8 tau's total
      %t#1.c1#1%
      [u11$1] (p111); [u12$1] (p211);
      %t#1.c1#2%
      [u11$1] (p112); [u12$1] (p212);
      %t#2.c1#1%
      [u11$1] (p121); [u12$1] (p221);
      %t#2.c1#2%
      [u11$1] (p122); [u12$1] (p222);
      	
  MODEL t.c2:
      %t#1.c2#1%
      [u21$1] (p111); [u22$1] (p211);
      %t#1.c2#2%
      [u21$1] (p112); [u22$1] (p212);
      %t#2.c2#1%
      [u21$1] (p121); [u22$1] (p221);
      %t#2.c2#2%
      [u21$1] (p122); [u22$1] (p222);
      	
   MODEL t.c3:
      %t#1.c3#1%
      [u31$1] (p111); [u32$1] (p211);
      %t#1.c3#2%
      [u31$1] (p112); [u32$1] (p212);
      %t#2.c3#1%
      [u31$1] (p121); [u32$1] (p221);
      %t#2.c3#2%
      [u31$1] (p122); [u32$1] (p222);

  MODEL t.c4:
      %t#1.c4#1%
      [u41$1] (p111); [u42$1] (p211);
      %t#1.c4#2%
      [u41$1] (p112); [u42$1] (p212);
      %t#2.c4#1%
      [u41$1] (p121); [u42$1] (p221);
      %t#2.c4#2%
      [u41$1] (p122); [u42$1] (p222); ",
 
  MODELCONSTRAINT = ~
     "! each item has intercept, loading on trait, loading on occasion
      ! so no trait-occasion interaction
          New(i1 i2 lt1 lt2 lo1 lo2);
          p111 = i1;
          p112 = i1 + lo1;
          p121 = i1 + lt1;
          p122 = i1 + lo1 + lt1;
          p211 = i2;
          p212 = i2 + lo2;
          p221 = i2 + lt2;
          p222 = i2 + lo2 + lt2;")

m2_mood.fit <- mplusModeler(m2_mood,
                            dataout =here("mood_mplus", "m1_mood.dat"), 
                            modelout=here("mood_mplus", "m2_mood.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)
```

***

## Mood Model 3  - RI-LTA, Continuous RI

***

NOTE: use of `update()`, selected syntax is used from base model `m1_mood` 
```{r}

m3_mood  <- update(m1_mood,
      
  TITLE = ~
     "Eid 2003 data: T=4, N=494, P=2, C=2
      Model 3 - RI Continuous", 
  
  ANALYSIS = ~ .+
     "algorithm = integration;
      integration = 30;",
  
  MODEL = ~
     "%OVERALL%

   ! Stationarity imposed:
    [c2#1 - c4#1] (p0);
    
    c4#1 on c3#1 (pt);
    c3#1 on c2#1 (pt);
    c2#1 on c1#1 (pt);
    
    f by u11-u12* (p1-p2)
         u21-u22* (p1-p2)
         u31-u32* (p1-p2)
         u41-u42* (p1-p2);
    f@1; [f@0];

    MODEL c1:
      	%c1#1%
      	[u11$1] (1);   [u12$1] (2);
      	%c1#2%
      	[u11$1] (11);  [u12$1] (12);
      	
    MODEL c2: 	
      	%c2#1%
      	[u21$1] (1);  [u22$1] (2);
      	%c2#2%
      	[u21$1] (11); [u22$1] (12);
      	
    MODEL c3:
        %c3#1%
      	[u31$1] (1);  [u32$1] (2);
      	%c3#2%
      	[u31$1] (11); [u32$1] (12);

    MODEL c4:
        %c4#1%
      	[u41$1] (1);  [u42$1] (2);
      	%c4#2%
      	[u41$1] (11); [u42$1] (12); ",
 
   OUTPUT = ~.+ "tech8;",
  
  usevariables = colnames(mood_data),
  rdata = mood_data)

m3_mood.fit <- mplusModeler(m3_mood,
                            dataout =here("mood_mplus", "m1_mood.dat"), 
                            modelout=here("mood_mplus", "m3_mood.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)
```

***

## Mood Model 4  - Regular LTA - Mover-Stayer

***

```{r}

m4_mood  <- mplusObject(
      
  TITLE = 
     "Eid 2003 data: T=4, N=494, P=2, C=2
      Model 4 - Regular LTA, Mover-Stayer", 
  
  VARIABLE =
     "usev = u11-u42;
      categorical = u11-u42;
      classes = cb(2) c1(2) c2(2) c3(2) c4(2);
      freqweight = freq;",
  
  ANALYSIS = 
     "type = mixture;
      proc = 8;
      starts = 80 16;
      parameterization = probability;",
  
  MODEL = 
     "%OVERALL%

    MODEL cb:
      %cb#1% ! Stationary movers
      c4 on c3 (pt1-pt2);
      c3 on c2 (pt1-pt2);
      c2 on c1 (pt1-pt2);

      %cb#2% ! Stayers
      c2#1 on c1#1@1; c2#1 on c1#2@0;
      c3#1 on c2#1@1; c3#1 on c2#2@0;
      c4#1 on c3#1@1; c4#1 on c3#2@0;

    MODEL c1:
      	%c1#1%
      	[u11$1] (1);   [u12$1] (2);
      	%c1#2%
      	[u11$1] (11);  [u12$1] (12);
      	
    MODEL c2: 	
      	%c2#1%
      	[u21$1] (1);  [u22$1] (2);
      	%c2#2%
      	[u21$1] (11); [u22$1] (12);
      	
    MODEL c3:
        %c3#1%
      	[u31$1] (1);  [u32$1] (2);
      	%c3#2%
      	[u31$1] (11); [u32$1] (12);

    MODEL c4:
        %c4#1%
      	[u41$1] (1);  [u42$1] (2);
      	%c4#2%
      	[u41$1] (11); [u42$1] (12); ",
 
  OUTPUT = "tech1 tech10 tech15;",
  
  usevariables = colnames(mood_data),
  rdata = mood_data)

m4_mood.fit <- mplusModeler(m4_mood,
                            dataout =here("mood_mplus", "m1_mood.dat"), 
                            modelout=here("mood_mplus", "m4_mood.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)
```

***

## Mood Model 5  - RI-LTA, binary RI, Mover-Stayer

***

```{r}

m5_mood  <- mplusObject(
      
  TITLE = 
     "Eid 2003 data: T=4, N=494, P=2, C=2
      Model 5 - RI-LTA, binary RI, Mover-Stayer", 
  
  VARIABLE =
     "usev = u11-u42;
      categorical = u11-u42;
      classes = t(2) cb(2) c1(2) c2(2) c3(2) c4(2);
      freqweight = freq;",
  
  ANALYSIS = 
     "type = mixture;
      proc = 8;
      starts = 320 80;
      parameterization = probability;",
  
  MODEL = 
     "%OVERALL%

    MODEL cb:
        %cb#1% ! Stationary movers
        c4 on c3 (pt1-pt2);
        c3 on c2 (pt1-pt2);
        c2 on c1 (pt1-pt2);
        
        %cb#2% ! Stayers
        c2#1 on c1#1@1; c2#1 on c1#2@0;
        c3#1 on c2#1@1; c3#1 on c2#2@0;
        c4#1 on c3#1@1; c4#1 on c3#2@0;

  MODEL t.c1:
      %t#1.c1#1%
      [u11$1] (p111); [u12$1] (p211);
      %t#1.c1#2%
      [u11$1] (p112); [u12$1] (p212);
      %t#2.c1#1%
      [u11$1] (p121); [u12$1] (p221);
      %t#2.c1#2%
      [u11$1] (p122); [u12$1] (p222);
      	
  MODEL t.c2:
      %t#1.c2#1%
      [u21$1] (p111); [u22$1] (p211);
      %t#1.c2#2%
      [u21$1] (p112); [u22$1] (p212);
      %t#2.c2#1%
      [u21$1] (p121); [u22$1] (p221);
      %t#2.c2#2%
      [u21$1] (p122); [u22$1] (p222);
      	
   MODEL t.c3:
      %t#1.c3#1%
      [u31$1] (p111); [u32$1] (p211);
      %t#1.c3#2%
      [u31$1] (p112); [u32$1] (p212);
      %t#2.c3#1%
      [u31$1] (p121); [u32$1] (p221);
      %t#2.c3#2%
      [u31$1] (p122); [u32$1] (p222);

  MODEL t.c4:
      %t#1.c4#1%
      [u41$1] (p111); [u42$1] (p211);
      %t#1.c4#2%
      [u41$1] (p112); [u42$1] (p212);
      %t#2.c4#1%
      [u41$1] (p121); [u42$1] (p221);
      %t#2.c4#2%
      [u41$1] (p122); [u42$1] (p222); ",
 
  MODELCONSTRAINT = 
     "! each item has intercept, loading on trait, loading on occasion
      ! so no trait-occasion interaction
          New(i1 i2 lt1 lt2 lo1 lo2);
          p111 = i1;
          p112 = i1 + lo1;
          p121 = i1 + lt1;
          p122 = i1 + lo1 + lt1;
          p211 = i2;
          p212 = i2 + lo2;
          p221 = i2 + lt2;
          p222 = i2 + lo2 + lt2;",
 
  OUTPUT = "tech1 tech10 tech15;",
  
  usevariables = colnames(mood_data),
  rdata = mood_data)

m5_mood.fit <- mplusModeler(m5_mood,
                            dataout =here("mood_mplus", "m1_mood.dat"), 
                            modelout=here("mood_mplus", "m5_mood.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)
```

***

## Mood Model 6 - RI-LTA - Continuous RI, Mover-Stayer

***

```{r}

m6_mood  <- mplusObject(
      
  TITLE = 
     "Eid 2003 data: T=4, N=494, P=2, C=2
      Model 6 - RI-LTA, Continuous RI, Mover-Stayer", 
  
  VARIABLE =
     "usev = u11-u42;
      categorical = u11-u42;
      classes = cb(2) c1(2) c2(2) c3(2) c4(2);
      freqweight = freq;",
  
  ANALYSIS = 
     "type = mixture;
      algorithm = integration;
      integration = 30;
      proc = 8;
      starts = 320 80;
      parameterization = probability;",
  
  MODEL = 
     "%OVERALL%
     
      f by u11-u12* (p1-p2)
           u21-u22* (p1-p2)
           u31-u32* (p1-p2)
           u41-u42* (p1-p2);
    	f@1; [f@0];

    MODEL cb:
        %cb#1% ! Stationary movers
        c4 on c3 (pt1-pt2);
        c3 on c2 (pt1-pt2);
        c2 on c1 (pt1-pt2);
        
        %cb#2% ! Stayers
        c2#1 on c1#1@1; c2#1 on c1#2@0;
        c3#1 on c2#1@1; c3#1 on c2#2@0;
        c4#1 on c3#1@1; c4#1 on c3#2@0;

    MODEL c1:
      	%c1#1%
      	[u11$1] (1);   [u12$1] (2);
      	%c1#2%
      	[u11$1] (11);  [u12$1] (12);
      	
    MODEL c2: 	
      	%c2#1%
      	[u21$1] (1);  [u22$1] (2);
      	%c2#2%
      	[u21$1] (11); [u22$1] (12);
      	
    MODEL c3:
        %c3#1%
      	[u31$1] (1);  [u32$1] (2);
      	%c3#2%
      	[u31$1] (11); [u32$1] (12);

    MODEL c4:
        %c4#1%
      	[u41$1] (1);  [u42$1] (2);
      	%c4#2%
      	[u41$1] (11); [u42$1] (12); ",
 
 
  OUTPUT = "tech1;",
  
  usevariables = colnames(mood_data),
  rdata = mood_data)

m6_mood.fit <- mplusModeler(m6_mood,
                            dataout =here("mood_mplus", "m1_mood.dat"), 
                            modelout=here("mood_mplus", "m6_mood.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)
```

***

# Dating data example (section 6.2; Lanza & Collins, 2008)

- National Longitudinal Survey of Youth (NLSY97)
- Sample size (N) = 2,937
- Time points = 3 (1 year apart)

Mixture model (LCA)
    - 4 ordinal and binary indicators ($Ui$)
    - 5 latent classes ($C_{k=5}$)

Indicators:
  - Past-year number of dating partners (0,1,2,more)
    - year 98 = u11, year 99 = u21, year 00 = u31
  - Past-year sex (no, yes)
    - year 98 = u12, year 99 = u22, year 00 = u32
  - Past-year number of sexual partners (0,1,2,more)
    - year 98 = u13, year 99 = u23, year 00 = u33
  - Past-year STD (no, yes)
    - year 98 = u14, year 99 = u24, year 00 = u34

Latent class labels (Lanza & Collins model):

1. Nondaters
2. Daters
3. Monogomous
4. Multipartner safe
4. Multipartner exposed

***

**Assumptions:** (following models in Eid & Langeheine, 2003)

**Applied to dating models 1 - 15**

1. Longitudinal invariance (across the 3 time point latent variables)
2. Stationarity invariance (across the 2 transition matrices)

***

**Models considered for the dating example:**

- Models 1-3: Standard analyses (Regular, Binary RI, Continuous RI)
- Models 4-6: Mover-Stayer analysis (Regular, Binary RI, Continuous RI)
- Models 7-10: Group-invariance MIMIC (grouping variable is male-female)
- Models 11-15: Adding 4 covariates and their interactions
***

```{r, echo=FALSE, eval=TRUE, out.width = "50%", out.height= "50%", fig.pos="h"}
knitr::include_graphics(here("figures", "table7_rilta.png"))
```

*Figure 8*: Picture adapted from Muthén & Asparouhov (2020).

***

Read in the `Dating` datafile
```{r}

date_data <-  read_csv(here("data", "LanzaCollinsLTA.csv"), col_names = FALSE) %>%  
  select(1:25) # select variables used in analysis
  
colnames(date_data) <-  c(
    "id", "gender", "male", "dates_98","dates_99","dates_00","par_98",
    "par_99","par_00","u11", "u21", "u31", "age_fd", "u12", "u22", "u32",
    "u13", "u23","u33","u14","u24","u34","safe_98","safe_99","safe_00")

```

***

# Comparison of LTA modeling approaches to the dating data example

## Dating Model 1 - Regular LTA

```{r}

m1_date <- mplusObject(
      
  TITLE = 
    "Dating Model 1 - Regular LTA - Invariance
     Lanza-Collins 2008 Developmental Psychology", 
  
  VARIABLE = 
     "usev = u11 u13 u14
       			 u21 u23 u24
       			 u31 u33 u34;
      
      categorical = u11-u34;
      missing = all(999);
      classes = c1(5) c2(5) c3(5);",
    
  ANALYSIS = 
     "type = mixture;
      processors = 8;
      starts = 160 40;",

  MODEL = 
 "%Overall%

      [c2#1 c3#1] (int1);
      [c2#2 c3#2] (int2);
      [c2#3 c3#3] (int3);
      [c2#4 c3#4] (int4);

      c2 on c1 (trans1-trans16); !!! Stationary transition assumption !!!
      c3 on c2 (trans1-trans16); 

  Model c1:
  	%c1#1%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p11-p15);
  	%c1#2%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p21-p25);
  	%c1#3%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p31-p35);
  	%c1#4%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p41-p45);
  	%c1#5%
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p51-p55);

  Model c2:
  	%c2#1%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p11-p15);
  	%c2#2%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p21-p25);
  	%c2#3%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p31-p35);
  	%c2#4%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p41-p45);
  	%c2#5%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p51-p55);

  Model c3:
  	%c3#1%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p11-p15);
  	%c3#2%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p21-p25);
  	%c3#3%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p31-p35);
  	%c3#4%
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p41-p45);
  	%c3#5%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p51-p55);",

  OUTPUT = "tech1 tech15 svalues;",
  
  usevariables = colnames(date_data),
  rdata = date_data)

m1_date.fit <- mplusModeler(m1_date, 
                            modelout=here("date_mplus", "m1_date.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)

```

***

## Dating Model 2 -  RI-LTA, binary RI

```{r}

m2_date <- mplusObject(
      
  TITLE = 
    "Lanza-Collins 2008 Developmental Psychology
   	 Dating Model 2 - N=2937, T=3, P=4, C=5", 
  
  VARIABLE = 
     "usev = u11 u13 u14
       			 u21 u23 u24
       			 u31 u33 u34;
      
      categorical = u11-u34;
      missing = all(999);
      classes = t(2) c1(5) c2(5) c3(5);",
    
  ANALYSIS = 
     "type = mixture;
      processors = 8;
      starts = 320 80;",

  MODEL = 
 "%Overall%

      [c2#1 c3#1] (int1);
      [c2#2 c3#2] (int2);
      [c2#3 c3#3] (int3);
      [c2#4 c3#4] (int4);

      c2 on c1 (trans1-trans16); !!! Stationary transition assumption !!!
      c3 on c2 (trans1-trans16);

  Model t.c1:
  	%t#1.c1#1%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p111-p115);
  	%t#1.c1#2%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p121-p125);
  	%t#1.c1#3%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p131-p135);
  	%t#1.c1#4%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p141-p145);
  	%t#1.c1#5%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p151-p155);

    %t#2.c1#1%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p211-p215);
  	%t#2.c1#2%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p221-p225);
  	%t#2.c1#3%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p231-p235);
  	%t#2.c1#4%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p241-p245);
  	%t#2.c1#5%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p251-p255);

  Model t.c2:
  	%t#1.c2#1%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p111-p115);
  	%t#1.c2#2%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p121-p125);
  	%t#1.c2#3%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p131-p135);
  	%t#1.c2#4%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p141-p145);
  	%t#1.c2#5%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p151-p155);

    %t#2.c2#1%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p211-p215);
  	%t#2.c2#2%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p221-p225);
  	%t#2.c2#3%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p231-p235);
  	%t#2.c2#4%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p241-p245);
  	%t#2.c2#5%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p251-p255);

  Model t.c3:
  	%t#1.c3#1%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p111-p115);
  	%t#1.c3#2%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p121-p125);
  	%t#1.c3#3%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p131-p135);
  	%t#1.c3#4%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p141-p145);
  	%t#1.c3#5%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p151-p155);

    %t#2.c3#1%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p211-p215);
  	%t#2.c3#2%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p221-p225);
  	%t#2.c3#3%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p231-p235);
  	%t#2.c3#4%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p241-p245);
  	%t#2.c3#5%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p251-p255);",
 
   MODELCONSTRAINT = 
     "new(a1-a3 b12-b15 b22-b25 b32-b35
      t1-t3 tau11 tau21 tau12 tau22 tau13
      tau23 tau14 tau24 tau15 tau25);
! t class 1:
      p111 = a1;                      ! c-class 1:
      p112 = a1+exp(tau11);           ! 2nd tau for 3-cat item
      p113 = a2;
      p114 = a2+exp(tau21);           ! 2nd tau for 3-cat item
      p115 = a3;
      p121 = a1+b12;                  ! c-class 2:
      p122 = a1+exp(tau12)+b12;
      p123 = a2+b22;
      p124 = a2+exp(tau22)+b22;
      p125 = a3+b32;
      p131 = a1+b13;                  ! c-class 3:
      p132 = a1+exp(tau13)+b13;
      p133 = a2+b23;
      p134 = a2+exp(tau23)+b23;
      p135 = a3+b33;
      p141 = a1+b14;                  ! c-class 4:
      p142 = a1+exp(tau14)+b14;
      p143 = a2+b24;
      p144 = a2+exp(tau24)+b24;
      p145 = a3+b34;
      p151 = a1+b15;                  ! c-class 5:
      p152 = a1+exp(tau15)+b15;
      p153 = a2+b25;
      p154 = a2+exp(tau25)+b25;
      p155 = a3+b35;
! t class 2:
      p211 = a1+t1;                   ! c-class 1:
      p212 = a1+exp(tau11)+t1;        ! 2nd tau for 3-cat item
      p213 = a2+t2;
      p214 = a2+exp(tau21)+t2;        ! 2nd tau for 3-cat item
      p215 = a3+t3;
      p221 = a1+b12+t1;               ! c-class 2:
      p222 = a1+exp(tau12)+b12+t1;
      p223 = a2+b22+t2;
      p224 = a2+exp(tau22)+b22+t2;
      p225 = a3+b32+t3;
      p231 = a1+b13+t1;               ! c-class 3:
      p232 = a1+exp(tau13)+b13+t1;
      p233 = a2+b23+t2;
      p234 = a2+exp(tau23)+b23+t2;
      p235 = a3+b33+t3;
      p241 = a1+b14+t1;               ! c-class 4:
      p242 = a1+exp(tau14)+b14+t1;
      p243 = a2+b24+t2;
      p244 = a2+exp(tau24)+b24+t2;
      p245 = a3+b34+t3;
      p251 = a1+b15+t1;               ! c-class 5:
      p252 = a1+exp(tau15)+b15+t1;
      p253 = a2+b25+t2;
      p254 = a2+exp(tau25)+b25+t2;
      p255 = a3+b35+t3;",

  OUTPUT = "tech1;",
  
  usevariables = colnames(date_data),
  rdata = date_data)

m2_date.fit <- mplusModeler(m2_date,
                            dataout=here("date_mplus", "date.dat"),
                            modelout=here("date_mplus", "m2_date.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)
```

## Dating Model 3 -  RI-LTA, continuous RI 

NOTE: use of `update()`, selected syntax is used from base model `m1_date` 
```{r}

m3_date <- update(m1_date, 
  
    TITLE = ~
    "Dating Model 3 - Continuous RI-LTA - invariance
     Lanza-Collins 2008 Developmental Psychology", 
    
    ANALYSIS = ~.+
      "algorithm = integration;",
    
    MODEL = ~
      "%Overall%
      [c2#1 c3#1] (int1);
      [c2#2 c3#2] (int2);
      [c2#3 c3#3] (int3);
      [c2#4 c3#4] (int4);
      
      c2 on c1 (trans1-trans16);  !!! Stationary transition assumption !!!
      c3 on c2 (trans1-trans16);

      f by u11-u14* (lam1-lam3)
  	  u21-u24* (lam1-lam3)
  	  u31-u34* (lam1-lam3);
  	  f@1; [f@0];

  Model c1:
  	%c1#1%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p11-p15);
  	%c1#2%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p21-p25);
  	%c1#3%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p31-p35);
  	%c1#4%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p41-p45);
  	%c1#5%
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p51-p55);

  Model c2:
  	%c2#1%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p11-p15);
  	%c2#2%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p21-p25);
  	%c2#3%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p31-p35);
  	%c2#4%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p41-p45);
  	%c2#5%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p51-p55);

  Model c3:
  	%c3#1%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p11-p15);
  	%c3#2%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p21-p25);
  	%c3#3%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p31-p35);
  	%c3#4%
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p41-p45);
  	%c3#5%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p51-p55);",
    
    MODELCONSTRAINT = ~ "",
    
    OUTPUT = ~
      "tech1 tech15 svalues;")
 
m3_date.fit <- mplusModeler(m3_date,
                            dataout=here("date_mplus", "date.dat"),
                            modelout=here("date_mplus", "m3_date.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)     

```


## Dating Model 4 - Regular LTA, Mover-Stayer

```{r}

m4_date <- mplusObject(
  
    TITLE = 
    " Dating Model 4 - Lanza-Collins 2008 Developmental Psychology
   	 Continuous RI-LTA",
    
    VARIABLE = 
      "usev = u11 u13 u14
              u21 u23 u24
              u31 u33 u34;
    
       categorical = u11-u34;
       missing = all(999);
       classes = cb(2) c1(5) c2(5) c3(5);",
    
    ANALYSIS = 
      "type = mixture;
  	   starts =  100 20;
  	   processors = 8;
       parameterization = probability;",
    
    MODEL = 
  "%Overall%
  
  Model cb:
  
  %cb#1% 
      c2 on c1 (pt1-pt20);  !!! Stationary transition assumption !!!
      c3 on c2 (pt1-pt20);

  %cb#2% !!! Stayer class.  Going row by row: !!!
      c2#1 on c1#1@1; c2#2 on c1#1@0; c2#3 on c1#1@0; c2#4 on c1#1@0;
      c2#1 on c1#2@0; c2#2 on c1#2@1; c2#3 on c1#2@0; c2#4 on c1#2@0;
      c2#1 on c1#3@0; c2#2 on c1#3@0; c2#3 on c1#3@1; c2#4 on c1#3@0;
      c2#1 on c1#4@0; c2#2 on c1#4@0; c2#3 on c1#4@0; c2#4 on c1#4@1;
      c2#1 on c1#5@0; c2#2 on c1#5@0; c2#3 on c1#5@0; c2#4 on c1#5@0;

      c3#1 on c2#1@1; c3#2 on c2#1@0; c3#3 on c2#1@0; c3#4 on c2#1@0;
      c3#1 on c2#2@0; c3#2 on c2#2@1; c3#3 on c2#2@0; c3#4 on c2#2@0;
      c3#1 on c2#3@0; c3#2 on c2#3@0; c3#3 on c2#3@1; c3#4 on c2#3@0;
      c3#1 on c2#4@0; c3#2 on c2#4@0; c3#3 on c2#4@0; c3#4 on c2#4@1;
      c3#1 on c2#5@0; c3#2 on c2#5@0; c3#3 on c2#5@0; c3#4 on c2#5@0;
  
  Model c1:
  	%c1#1%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p11-p15);
  	%c1#2%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p21-p25);
  	%c1#3%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p31-p35);
  	%c1#4%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p41-p45);
  	%c1#5%
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p51-p55);

  Model c2:
  	%c2#1%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p11-p15);
  	%c2#2%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p21-p25);
  	%c2#3%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p31-p35);
  	%c2#4%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p41-p45);
  	%c2#5%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p51-p55);

  Model c3:
  	%c3#1%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p11-p15);
  	%c3#2%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p21-p25);
  	%c3#3%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p31-p35);
  	%c3#4%
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p41-p45);
  	%c3#5%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p51-p55);",
    
    OUTPUT = "tech1;",
  
    usevariables = colnames(date_data),
    rdata = date_data)
 
m4_date.fit <- mplusModeler(m4_date,
                            dataout=here("date_mplus", "date.dat"),
                            modelout=here("date_mplus", "m4_date.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)     

```

## Dating Model 5 - RI-LTA, binary RI, Mover-Stayer

NOTE: use of `update()`, selected syntax is used from base model `m2_date` 
```{r}

m5_date <- update(m2_date,
      
  TITLE = ~
    "Lanza-Collins 2008 Developmental Psychology
   	 Dating Model 5a - RI-LTA, binary RI, Mover-Stayer", 
  
  VARIABLE = ~
     "usev = u11 u13 u14
       			 u21 u23 u24
       			 u31 u33 u34;
      
      categorical = u11-u34;
      missing = all(999);
      classes = t(2) cb(2) c1(5) c2(5) c3(5);",
    
  ANALYSIS = ~.+
     "parameterization = probability;",

  MODEL = ~
 "%Overall%

  Model cb:
  
  %cb#1% 
      c2 on c1 (pt1-pt20);  !!! Stationary transition assumption !!!
      c3 on c2 (pt1-pt20);

  %cb#2% !!! Stayer class !!!
      c2#1 on c1#1@1; c2#2 on c1#1@0; c2#3 on c1#1@0; c2#4 on c1#1@0;
      c2#1 on c1#2@0; c2#2 on c1#2@1; c2#3 on c1#2@0; c2#4 on c1#2@0;
      c2#1 on c1#3@0; c2#2 on c1#3@0; c2#3 on c1#3@1; c2#4 on c1#3@0;
      c2#1 on c1#4@0; c2#2 on c1#4@0; c2#3 on c1#4@0; c2#4 on c1#4@1;
      c2#1 on c1#5@0; c2#2 on c1#5@0; c2#3 on c1#5@0; c2#4 on c1#5@0;

      c3#1 on c2#1@1; c3#2 on c2#1@0; c3#3 on c2#1@0; c3#4 on c2#1@0;
      c3#1 on c2#2@0; c3#2 on c2#2@1; c3#3 on c2#2@0; c3#4 on c2#2@0;
      c3#1 on c2#3@0; c3#2 on c2#3@0; c3#3 on c2#3@1; c3#4 on c2#3@0;
      c3#1 on c2#4@0; c3#2 on c2#4@0; c3#3 on c2#4@0; c3#4 on c2#4@1;
      c3#1 on c2#5@0; c3#2 on c2#5@0; c3#3 on c2#5@0; c3#4 on c2#5@0;

  Model t.c1:
  	%t#1.c1#1%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p111-p115);
  	%t#1.c1#2%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p121-p125);
  	%t#1.c1#3%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p131-p135);
  	%t#1.c1#4%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p141-p145);
  	%t#1.c1#5%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p151-p155);

    %t#2.c1#1%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p211-p215);
  	%t#2.c1#2%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p221-p225);
  	%t#2.c1#3%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p231-p235);
  	%t#2.c1#4%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p241-p245);
  	%t#2.c1#5%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p251-p255);

  Model t.c2:
  	%t#1.c2#1%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p111-p115);
  	%t#1.c2#2%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p121-p125);
  	%t#1.c2#3%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p131-p135);
  	%t#1.c2#4%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p141-p145);
  	%t#1.c2#5%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p151-p155);

    %t#2.c2#1%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p211-p215);
  	%t#2.c2#2%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p221-p225);
  	%t#2.c2#3%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p231-p235);
  	%t#2.c2#4%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p241-p245);
  	%t#2.c2#5%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p251-p255);

  Model t.c3:
  	%t#1.c3#1%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p111-p115);
  	%t#1.c3#2%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p121-p125);
  	%t#1.c3#3%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p131-p135);
  	%t#1.c3#4%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p141-p145);
  	%t#1.c3#5%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p151-p155);

    %t#2.c3#1%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p211-p215);
  	%t#2.c3#2%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p221-p225);
  	%t#2.c3#3%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p231-p235);
  	%t#2.c3#4%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p241-p245);
  	%t#2.c3#5%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p251-p255);" )

m5_date.fit <- mplusModeler(m5_date,
                            dataout=here("date_mplus", "date.dat"),
                            modelout=here("date_mplus", "m5_date.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)
```

***

## Dating Model 6 - RI-LTA, continuous RI, Mover-Stayer

```{r}

m6_date <-  mplusObject(
      
  TITLE = 
    "Dating Model 6a - RI-LTA, continuous RI, Mover-Stayer
     Lanza-Collins 2008 Developmental Psychology", 
  
  VARIABLE =
     "usev = u11 u13 u14
       			 u21 u23 u24
       			 u31 u33 u34;
      
      categorical = u11-u34;
      missing = all(999);
      classes = cb(2) c1(5) c2(5) c3(5);",
    
  ANALYSIS = 
    "type = mixture;
  	 starts =  100 20;
  	 processors = 8;
     parameterization = probability;
     algorithm = integration;",

  MODEL = 
   "%Overall%

    f by u11-u14* (lam1-lam3)
  	u21-u24* (lam1-lam3)
  	u31-u34* (lam1-lam3);
  	f@1; [f@0];
  	
  Model cb:
  
  %cb#1% !!! Stationary transition assumption !!!
      c2 on c1 (pt1-pt20);
      c3 on c2 (pt1-pt20);

  %cb#2% !!! Stayer class.  Going row by row: !!!
      c2#1 on c1#1@1; c2#2 on c1#1@0; c2#3 on c1#1@0; c2#4 on c1#1@0;
      c2#1 on c1#2@0; c2#2 on c1#2@1; c2#3 on c1#2@0; c2#4 on c1#2@0;
      c2#1 on c1#3@0; c2#2 on c1#3@0; c2#3 on c1#3@1; c2#4 on c1#3@0;
      c2#1 on c1#4@0; c2#2 on c1#4@0; c2#3 on c1#4@0; c2#4 on c1#4@1;
      c2#1 on c1#5@0; c2#2 on c1#5@0; c2#3 on c1#5@0; c2#4 on c1#5@0;

      c3#1 on c2#1@1; c3#2 on c2#1@0; c3#3 on c2#1@0; c3#4 on c2#1@0;
      c3#1 on c2#2@0; c3#2 on c2#2@1; c3#3 on c2#2@0; c3#4 on c2#2@0;
      c3#1 on c2#3@0; c3#2 on c2#3@0; c3#3 on c2#3@1; c3#4 on c2#3@0;
      c3#1 on c2#4@0; c3#2 on c2#4@0; c3#3 on c2#4@0; c3#4 on c2#4@1;
      c3#1 on c2#5@0; c3#2 on c2#5@0; c3#3 on c2#5@0; c3#4 on c2#5@0;

  Model c1:
  	%c1#1%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p11-p15);
  	%c1#2%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p21-p25);
  	%c1#3%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p31-p35);
  	%c1#4%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p41-p45);
  	%c1#5%
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p51-p55);

  Model c2:
  	%c2#1%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p11-p15);
  	%c2#2%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p21-p25);
  	%c2#3%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p31-p35);
  	%c2#4%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p41-p45);
  	%c2#5%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p51-p55);

  Model c3:
  	%c3#1%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p11-p15);
  	%c3#2%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p21-p25);
  	%c3#3%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p31-p35);
  	%c3#4%
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p41-p45);
  	%c3#5%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p51-p55);",
  
    usevariables = colnames(date_data),
    rdata = date_data)
 
m6_date.fit <- mplusModeler(m6_date,
                            dataout=here("date_mplus", "date.dat"),
                            modelout=here("date_mplus", "m6_date.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)
```

***

# Dating Example - Cross-group Invariance (MIMIC)

Comparing **Regular LTA** to **RI-LTA**

***

## Dating Model 7, Regular LTA, non-invariance

```{r}

m7_date <- mplusObject(
  
    TITLE = 
    "Dating Model 7, Regular LTA,  non-invariance
     Lanza-Collins 2008 Developmental Psychology", 
    
    VARIABLE =  
      "usev = u11 u13 u14
  		        u21 u23 u24
  		        u31 u33 u34
  		        male;        !!! grouping covariate !!!

  	categorical = u11-u34;
  	missing = all(999);

  	classes = c1(5) c2(5) c3(5);",
    
    ANALYSIS = 
    "type = mixture;
  	 starts =  320 80;
  	 processors = 8;",
      
    MODEL = 
      "%Overall%
       c1 on male;

      c2#1 on male (int1); c3#1 on male (int1);
      c2#2 on male (int2); c3#2 on male (int2);
      c2#3 on male (int3); c3#3 on male (int3);
      c2#4 on male (int4); c3#4 on male (int4);

      	c2 on c1 (trans1-trans16);
      	c3 on c2 (trans1-trans16);

      u11-u34 on male@0;

  Model c1:
  	%c1#1%!
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p11-p15);
  	%c1#2%
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p21-p25);
  	%c1#3%
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p31-p35);
  	%c1#4%
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p41-p45);
  	%c1#5%
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p51-p55);

  Model c2:
  	%c2#1%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p11-p15);
  	%c2#2%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p21-p25);
  	%c2#3%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p31-p35);
  	%c2#4%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p41-p45);
  	%c2#5%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p51-p55);

  Model c3:
  	%c3#1%
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p11-p15);
  	%c3#2%
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p21-p25);
  	%c3#3%
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p31-p35);
  	%c3#4%
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p41-p45);
  	%c3#5%
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p51-p55);",
    
    OUTPUT =  "",
  
    usevariables = colnames(date_data),
    rdata = date_data)
  
 
m7_date.fit <- mplusModeler(m7_date,
                            dataout=here("date_mplus", "date.dat"),
                            modelout=here("date_mplus", "m7_date.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)     
```

***

## Dating Model 8, Regular LTA, invariance

NOTE: use of `update()`, selected syntax is used from base model `m7_date` 
```{r}

m8_date <- update(m7_date, 
  
    TITLE = ~
    "Dating Model 8, Regular LTA, invariance
     Lanza-Collins 2008 Developmental Psychology", 
      
    ANALYSIS = ~
    "type = mixture;
  	 starts =  160 40;
  	 processors = 8;",
    
    MODEL = ~
      "%Overall%
       c1 on male;

      c2#1 on male (int1); c3#1 on male (int1);
      c2#2 on male (int2); c3#2 on male (int2);
      c2#3 on male (int3); c3#3 on male (int3);
      c2#4 on male (int4); c3#4 on male (int4);

      	c2 on c1 (trans1-trans16);
      	c3 on c2 (trans1-trans16);

      u11-u34 on male@0;

  Model c1:
  	%c1#1%!
      u11-u14 on male (d11-d13);   !!! cross-group invariance equality constraints !!!
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p11-p15);
  	%c1#2%
      u11-u14 on male (d21-d23);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p21-p25);
  	%c1#3%
      u11-u14 on male (d31-d33);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p31-p35);
  	%c1#4%
      u11-u14 on male (d41-d43);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p41-p45);
  	%c1#5%
      u11-u14 on male (d51-d53);
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p51-p55);

  Model c2:
  	%c2#1%
      u21-u24 on male (d11-d13);   !!! cross-group invariance equality constraints !!!
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p11-p15);
  	%c2#2%
      u21-u24 on male (d21-d23);
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p21-p25);
  	%c2#3%
      u21-u24 on male (d31-d33);
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p31-p35);
  	%c2#4%
      u21-u24 on male (d41-d43);
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p41-p45);
  	%c2#5%
      u21-u24 on male (d51-d53);
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p51-p55);

  Model c3:
  	%c3#1%
      u31-u34 on male (d11-d13);   !!! cross-group invariance equality constraints !!!
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p11-p15);
  	%c3#2%
      u31-u34 on male (d21-d23);
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p21-p25);
  	%c3#3%
      u31-u34 on male (d31-d33);
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p31-p35);
  	%c3#4%
      u31-u34 on male (d41-d43);
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p41-p45);
  	%c3#5%
      u31-u34 on male (d51-d53);
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p51-p55);")
 
m8_date.fit <- mplusModeler(m8_date,
                            dataout=here("date_mplus", "date.dat"),
                            modelout=here("date_mplus", "m8_date.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)     
```

***

## Dating Model 9, RI-LTA, non-invariance

NOTE: use of `update()`, selected syntax is used from base model `m7_date` 
```{r}

m9_date <- update(m7_date, 
  
    TITLE = ~
    "Dating Model 9, Regular LTA, non-invariance
     Lanza-Collins 2008 Developmental Psychology", 
    
        ANALYSIS = ~
       "algorithm = integration;
        stscale = 1;",
    
    MODEL = ~
      "%Overall%
       c1 on male;

      c2#1 on male (int1); c3#1 on male (int1);
      c2#2 on male (int2); c3#2 on male (int2);
      c2#3 on male (int3); c3#3 on male (int3);
      c2#4 on male (int4); c3#4 on male (int4);

      c2 on c1 (trans1-trans16);
      c3 on c2 (trans1-trans16);

      f by u11-u14* (lam1-lam3)  !!! continuous random intercept !!!
  	  u21-u24* (lam1-lam3)
  	  u31-u34* (lam1-lam3);
  	  f@1; [f@0];
  	
      u11-u34 on male@0;

  Model c1:
  	%c1#1%
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p11-p15);
  	%c1#2%
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p21-p25);
  	%c1#3%
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p31-p35);
  	%c1#4%
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p41-p45);
  	%c1#5%
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p51-p55);

  Model c2:
  	%c2#1%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p11-p15);
  	%c2#2%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p21-p25);
  	%c2#3%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p31-p35);
  	%c2#4%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p41-p45);
  	%c2#5%
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p51-p55);

  Model c3:
  	%c3#1%
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p11-p15);
  	%c3#2%
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p21-p25);
  	%c3#3%
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p31-p35);
  	%c3#4%
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p41-p45);
  	%c3#5%
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p51-p55);",
    
    OUTPUT = ~ "tech15;")
 
m9_date.fit <- mplusModeler(m9_date,
                            dataout=here("date_mplus", "date.dat"),
                            modelout=here("date_mplus", "m9_date.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)     
```

***

## Dating Model 10, RI-LTA, invariance

NOTE: use of `update()`, selected syntax is used from base model `m9_date` 
```{r}

m10_date <- update(m9_date, 
  
    TITLE = ~
    "Dating Model 10, Regular LTA, invariance
     Lanza-Collins 2008 Developmental Psychology", 
    
    ANALYSIS = ~
    "type = mixture;
  	 starts =  400 100; !!! estimation time ~ > 30 minutes !!! 
  	 proc = 8;
     algorithm = integration;
     integration = 30;",
    
    MODEL = ~
      "%Overall%
       c1 on male;

      c2#1 on male (int1); c3#1 on male (int1);
      c2#2 on male (int2); c3#2 on male (int2);
      c2#3 on male (int3); c3#3 on male (int3);
      c2#4 on male (int4); c3#4 on male (int4);

      c2 on c1 (trans1-trans16);
      c3 on c2 (trans1-trans16);

      f by u11-u14* (lam1-lam3)  !!! continuous random intercept !!!
  	  u21-u24* (lam1-lam3)
  	  u31-u34* (lam1-lam3);
  	  f@1; [f@0];
  	  
      u11-u34 on male@0;

  Model c1:
  	%c1#1%!
      u11-u14 on male (d11-d13);   !!! cross-group invariance equality constraints !!!
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p11-p15);
  	%c1#2%
      u11-u14 on male (d21-d23);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p21-p25);
  	%c1#3%
      u11-u14 on male (d31-d33);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p31-p35);
  	%c1#4%
      u11-u14 on male (d41-d43);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p41-p45);
  	%c1#5%
      u11-u14 on male (d51-d53);
  	[u11$1 u11$2 u13$1 u13$2 u14$1] (p51-p55);

  Model c2:
  	%c2#1%
      u21-u24 on male (d11-d13);   !!! cross-group invariance equality constraints !!!
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p11-p15);
  	%c2#2%
      u21-u24 on male (d21-d23);
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p21-p25);
  	%c2#3%
      u21-u24 on male (d31-d33);
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p31-p35);
  	%c2#4%
      u21-u24 on male (d41-d43);
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p41-p45);
  	%c2#5%
      u21-u24 on male (d51-d53);
  	[u21$1 u21$2 u23$1 u23$2 u24$1] (p51-p55);

  Model c3:
  	%c3#1%
      u31-u34 on male (d11-d13);   !!! cross-group invariance equality constraints !!!
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p11-p15);
  	%c3#2%
      u31-u34 on male (d21-d23);
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p21-p25);
  	%c3#3%
      u31-u34 on male (d31-d33);
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p31-p35);
  	%c3#4%
      u31-u34 on male (d41-d43);
  	[u31$1 u31$2 u33$1 u33$2 u34$1] (p41-p45);
  	%c3#5%
      u31-u34 on male (d51-d53);
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p51-p55);")
 
m10_date.fit <- mplusModeler(m10_date,
                            dataout=here("date_mplus", "date.dat"),
                            modelout=here("date_mplus", "m10_date.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)     
```

***

# Adding covariates and interactions to the dating example

**Four binary covariates:**

- gender: 0 = Female, 1 = Male 
- cigarettes: 0 = Did not use, 1 = Used in past year
- drunk: 0 = Did not use, 1 = Used in past year
- marijuana: 0 = Did not use, 1 = Used in past year

***

## Dating Model 11 - regular LTA - main effects

```{r}
m11_date <- mplusObject(
  
    TITLE = 
    "Dating Model 11, regular LTA, main effects
     Lanza-Collins 2008 Developmental Psychology", 
    
    VARIABLE =  
      "usev = u11 u13 u14
  		        u21 u23 u24
  		        u31 u33 u34
  		        male x11 x12 x13;   !!! grouping covariate !!!

  	categorical = u11-u34;
  	missing = all(999);

  	classes = c1(5) c2(5) c3(5);",
    
    ANALYSIS = 
    "type = mixture;
  	 starts =  320 80;
  	 processors = 8;",
      
    MODEL = 
      "%Overall%
  	   [c2#1 c3#1] (int1);
       [c2#2 c3#2] (int2);
       [c2#3 c3#3] (int3);
       [c2#4 c3#4] (int4);

       c2 on c1 (trans1-trans16);
       c3 on c2 (trans1-trans16);

       c1 on male x11 x12 x13;
 
       c2 on male x11 x12 x13 (slp1-slp16);
       c3 on male x11 x12 x13 (slp1-slp16);

  Model c1:
  	%c1#1%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p11-p15);
  	%c1#2%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p21-p25);
  	%c1#3%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p31-p35);
  	%c1#4%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p41-p45);
  	%c1#5%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p51-p55);

  Model c2:
  	%c2#1%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p11-p15);
  	%c2#2%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p21-p25);
  	%c2#3%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p31-p35);
  	%c2#4%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p41-p45);
  	%c2#5%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p51-p55);

  Model c3:
  	%c3#1%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p11-p15);
  	%c3#2%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p21-p25);
  	%c3#3%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p31-p35);
  	%c3#4%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p41-p45);
  	%c3#5%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p51-p55);",
    
    OUTPUT = "tech15;",
  
    usevariables = colnames(date_data),
    rdata = date_data)
  
m11_date.fit <- mplusModeler(m11_date,
                            dataout=here("date_mplus", "date.dat"),
                            modelout=here("date_mplus", "m11_date.inp"),
                            check=TRUE, run = TRUE, hashfilename = FALSE)     
```

***

## Dating Model 12 - regular LTA - main effects & gender interaction effects

NOTE: use of `update()`, selected syntax is used from base model `m11_date` 
```{r}
m12_date <- update(m11_date,
  
    TITLE = ~
    "Dating Model 12, regular LTA - main effects and gender interaction effects
     Lanza-Collins 2008 Developmental Psychology", 
    
    ANALYSIS = ~.+
    "stscale = 1;",
      
    MODEL = ~
      "%Overall%
  	   [c2#1 c3#1] (int1);
       [c2#2 c3#2] (int2);
       [c2#3 c3#3] (int3);
       [c2#4 c3#4] (int4);

       c2 on c1 (trans1-trans16);
       c3 on c2 (trans1-trans16);

       c1 on male x11 x12 x13;
 
       c2 on male x11 x12 x13 (slp1-slp16);
       c3 on male x11 x12 x13 (slp1-slp16);

  Model c1:
  	%c1#1%
      c2 on male (tr1-tr4);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p11-p15);
  	%c1#2%
      c2 on male (tr21-tr24);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p21-p25);
  	%c1#3%
      c2 on male (tr31-tr34);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p31-p35);
  	%c1#4%
      c2 on male (tr41-tr44);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p41-p45);
  	%c1#5%
      c2 on male (tr51-tr54);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p51-p55);

  Model c2:
  	%c2#1%
      c3 on male (tr1-tr4);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p11-p15);
  	%c2#2%
      c3 on male (tr21-tr24);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p21-p25);
  	%c2#3%
      c3 on male (tr31-tr34);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p31-p35);
  	%c2#4%
      c3 on male (tr41-tr44);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p41-p45);
  	%c2#5%
      c3 on male (tr51-tr54);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p51-p55);

  Model c3:
  	%c3#1%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p11-p15);
  	%c3#2%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p21-p25);
  	%c3#3%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p31-p35);
  	%c3#4%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p41-p45);
  	%c3#5%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p51-p55);")
  
m12_date.fit <- mplusModeler(m12_date,
                  dataout=here("date_mplus", "date.dat"),
                  modelout=here("date_mplus", "m12_date.inp"),
                  check=TRUE, run = TRUE, hashfilename = FALSE)   
```

***

## Dating Model 13 - RI-LTA - continuous RI

NOTE: use of `update()`, selected syntax is used from base model `m11_date` 
```{r}
m13_date <- update(m11_date,
  
    TITLE = ~
    "Dating Model 13 - RI-LTA - continuous RI
     Lanza-Collins 2008 Developmental Psychology", 
    
    ANALYSIS = ~
     "type=mixture;
      starts = 480 160;
      processors = 8;
      algorithm=integration;
      integration = 30;
      stscale = 1;",
      
    MODEL = ~
      "%Overall%
  	   [c2#1 c3#1] (int1);
       [c2#2 c3#2] (int2);
       [c2#3 c3#3] (int3);
       [c2#4 c3#4] (int4);

       c2 on c1 (trans1-trans16);
       c3 on c2 (trans1-trans16);

       f by u11-u14* (lam1-lam3)
  	   u21-u24* (lam1-lam3)
  	   u31-u34* (lam1-lam3);
  	   f@1; [f@0];

       f on male x11 x12 x13;

  Model c1:
  	%c1#1%
      c2 on male (tr1-tr4);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p11-p15);
  	%c1#2%
      c2 on male (tr21-tr24);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p21-p25);
  	%c1#3%
      c2 on male (tr31-tr34);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p31-p35);
  	%c1#4%
      c2 on male (tr41-tr44);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p41-p45);
  	%c1#5%
      c2 on male (tr51-tr54);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p51-p55);

  Model c2:
  	%c2#1%
      c3 on male (tr1-tr4);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p11-p15);
  	%c2#2%
      c3 on male (tr21-tr24);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p21-p25);
  	%c2#3%
      c3 on male (tr31-tr34);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p31-p35);
  	%c2#4%
      c3 on male (tr41-tr44);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p41-p45);
  	%c2#5%
      c3 on male (tr51-tr54);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p51-p55);

  Model c3:
  	%c3#1%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p11-p15);
  	%c3#2%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p21-p25);
  	%c3#3%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p31-p35);
  	%c3#4%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p41-p45);
  	%c3#5%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p51-p55);")
  
m13_date.fit <- mplusModeler(m13_date,
                  dataout=here("date_mplus", "date.dat"),
                  modelout=here("date_mplus", "m13_date.inp"),
                  check=TRUE, run = TRUE, hashfilename = FALSE)   
```

***

## Dating Model 14 - RI-LTA - continuous RI - main effects 

NOTE: use of `update()`, selected syntax is used from base model `m11_date` 
```{r}
m14_date <- update(m11_date,
  
    TITLE = ~
    "Dating Model 14 - continuous RI - main effects 
     Lanza-Collins 2008 Developmental Psychology", 
    
    ANALYSIS = ~
     "type=mixture;
      starts = 320 80;
      processors = 8;
      algorithm=integration;",
      
    MODEL = ~
      "%Overall%
  	   [c2#1 c3#1] (int1);
       [c2#2 c3#2] (int2);
       [c2#3 c3#3] (int3);
       [c2#4 c3#4] (int4);

       c2 on c1 (trans1-trans16);
       c3 on c2 (trans1-trans16);

       f by u11-u14* (lam1-lam3)
  	   u21-u24* (lam1-lam3)
  	   u31-u34* (lam1-lam3);
  	   f@1; [f@0];

       f on male x11 x12 x13;
       
       c1 on male x11 x12 x13;
       c2 on male x11 x12 x13 (slp1-slp16);
       c3 on male x11 x12 x13 (slp1-slp16);

  Model c1:
  	%c1#1%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p11-p15);
  	%c1#2%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p21-p25);
  	%c1#3%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p31-p35);
  	%c1#4%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p41-p45);
  	%c1#5%
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p51-p55);

  Model c2:
  	%c2#1%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p11-p15);
  	%c2#2%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p21-p25);
  	%c2#3%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p31-p35);
  	%c2#4%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p41-p45);
  	%c2#5%
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p51-p55);

  Model c3:
  	%c3#1%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p11-p15);
  	%c3#2%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p21-p25);
  	%c3#3%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p31-p35);
  	%c3#4%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p41-p45);
  	%c3#5%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p51-p55);")
  
m14_date.fit <- mplusModeler(m14_date,
                  dataout=here("date_mplus", "date.dat"),
                  modelout=here("date_mplus", "m14_date.inp"),
                  check=TRUE, run = TRUE, hashfilename = FALSE)   
```

***

## Dating Model 15 - RI-LTA - continuous RI - main effects & gender interaction effects

NOTE: use of `update()`, selected syntax is used from base model `m11_date` 
```{r}
m15_date <- update(m11_date,
  
    TITLE = ~
    "Dating Model 15 - RI-LTA - continuous RI - main effects and gender interaction effects
     Lanza-Collins 2008 Developmental Psychology", 
    
    ANALYSIS = ~
     "type=mixture;
      starts = 320 80;
      processors = 8;
      integration = 20;
      algorithm=integration;",
      
    MODEL = ~
      "%Overall%
  	   [c2#1 c3#1] (int1);
       [c2#2 c3#2] (int2);
       [c2#3 c3#3] (int3);
       [c2#4 c3#4] (int4);

       c2 on c1 (trans1-trans16);
       c3 on c2 (trans1-trans16);

       f by u11-u14* (lam1-lam3)
  	   u21-u24* (lam1-lam3)
  	   u31-u34* (lam1-lam3);
  	   f@1; [f@0];

       f on male x11 x12 x13;
       
       c1 on male x11 x12 x13;
       c2 on male x11 x12 x13 (slp1-slp16);
       c3 on male x11 x12 x13 (slp1-slp16);

  Model c1:
  	%c1#1%
      c2 on male (tr1-tr4);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p11-p15);
  	%c1#2%
      c2 on male (tr21-tr24);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p21-p25);
  	%c1#3%
      c2 on male (tr31-tr34);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p31-p35);
  	%c1#4%
      c2 on male (tr41-tr44);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p41-p45);
  	%c1#5%
      c2 on male (tr51-tr54);
  	[u11$1 u11$2  u13$1 u13$2 u14$1] (p51-p55);

  Model c2:
  	%c2#1%
      c3 on male (tr1-tr4);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p11-p15);
  	%c2#2%
      c3 on male (tr21-tr24);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p21-p25);
  	%c2#3%
      c3 on male (tr31-tr34);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p31-p35);
  	%c2#4%
      c3 on male (tr41-tr44);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p41-p45);
  	%c2#5%
      c3 on male (tr51-tr54);
  	[u21$1 u21$2  u23$1 u23$2 u24$1] (p51-p55);

  Model c3:
  	%c3#1%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p11-p15);
  	%c3#2%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p21-p25);
  	%c3#3%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p31-p35);
  	%c3#4%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p41-p45);
  	%c3#5%
  	[u31$1 u31$2  u33$1 u33$2 u34$1] (p51-p55);")
  
m15_date.fit <- mplusModeler(m15_date,
                  dataout=here("date_mplus", "date.dat"),
                  modelout=here("date_mplus", "m15_date.inp"),
                  check=TRUE, run = TRUE, hashfilename = FALSE)   
```

______________________________________________

# [\textcolor{blue}{Return to Website Home Page}](https://garberadamc.github.io/project-site/)

______________________________________________

# References

Hallquist, M. N., & Wiley, J. F. (2018). MplusAutomation: An R Package for Facilitating Large-Scale Latent Variable Analyses in Mplus. Structural equation modeling: a multidisciplinary journal, 25(4), 621-638.

Muthén, B. & Asparouhov, T. (2020). [\textcolor{blue}{Latent Transition Analysis with Random Intercepts (RI-LTA)}](https://www.statmodel.com/download/MuthenRevision3.pdf). Under review. Version 3. 

Muthén, L.K. and Muthén, B.O. (1998-2017).  Mplus User’s Guide.  Eighth Edition. Los Angeles, CA: Muthén & Muthén

R Core Team (2017). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL http://www.R-project.org/

Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source Software, 4(43), 1686, https://doi.org/10.21105/joss.01686

---------------------------------------------------

![](figures/UCSB_Navy_mark.png){ width=75% }









